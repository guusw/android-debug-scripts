#!/bin/bash
# Run the script as ./launch_debug "PACKAGE_NAME" "ACTIVITY_NAME"
PACKAGE_NAME=$1
ACTIVITY_NAME=$2

LLDB_PORT=10002
JDB_PORT=10001

DEVICE_ID=$(cat .android_dbg/device_id)

echo "> Killing previous lldb server"
adb shell run-as $PACKAGE_NAME killall lldb-server &

# Launch package in debug mode
INTENT="$PACKAGE_NAME/$PACKAGE_NAME.$ACTIVITY_NAME"
echo "> Launching $INTENT"
adb shell am start -D -n "$INTENT" &

echo "> Copying lldb-server"
adb shell run-as $PACKAGE_NAME "cp -f /data/local/tmp/lldb-server /data/user/0/$PACKAGE_NAME"

# Start lldb server
echo "> Starting lldb server"
adb shell run-as $PACKAGE_NAME "./lldb-server platform --listen \"*:$LLDB_PORT\" --server" &

echo "> Waiting for process..."
while [ -z "$PID" ]
do
    PID=$(adb shell ps -A | grep "$PACKAGE_NAME" | sed -E -n 's/\w+\s+([0-9]+)\s+.*/\1/p')
    echo "..."
done

echo "> Launched $PACKAGE_NAME with PID $PID"

# Forward
adb forward tcp:$LLDB_PORT tcp:$LLDB_PORT
adb forward tcp:$JDB_PORT jdwp:$PID

mkdir -p .android_dbg
echo $JDB_PORT >.android_dbg/jdb_port
echo $LLDB_PORT >.android_dbg/lldb_port
echo $PID >.android_dbg/pid
